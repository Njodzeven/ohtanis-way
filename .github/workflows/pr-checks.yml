name: PR Quality Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  # Enforce code quality on PRs
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for better diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Check if there are any TODO/FIXME comments
      - name: Check for TODOs
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          if git diff origin/main HEAD | grep -E "(TODO|FIXME)" ; then
            echo "Found TODO/FIXME comments in changes"
            echo "This is just a warning, not blocking the PR"
          else
            echo "No TODOs or FIXMEs found"
          fi
        continue-on-error: true

      # Check for sensitive data
      - name: Check for secrets
        run: |
          echo "Checking for potential secrets..."
          if git diff origin/main HEAD | grep -iE "(api[_-]?key|password|secret|token)" ; then
            echo "Potential sensitive data detected!"
            echo "Please review your changes carefully"
          else
            echo "No obvious secrets detected"
          fi
        continue-on-error: true

      - name: PR size check
        run: |
          FILES_CHANGED=$(git diff --name-only origin/main HEAD | wc -l)
          echo "Files changed: $FILES_CHANGED"
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "This PR changes more than 50 files"
            echo "Consider breaking it into smaller PRs for easier review"
          else
            echo "PR size looks good"
          fi
        continue-on-error: true

  # Type checking
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Generate Prisma types
        working-directory: ./backend
        run: npx prisma generate

      - name: TypeScript check - Backend
        working-directory: ./backend
        run: npx tsc --noEmit
        continue-on-error: true

      - name: TypeScript check - Frontend
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: true
